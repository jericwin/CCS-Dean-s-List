<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='logo.png') }}"
      type="image/png"
    />
    <title>Admin Chat</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
      :root {
        --primary: #ff7a1a;
        --primary-hover: #e06b17;
        --secondary: #7b1f1f;
        --bg-dark: #121212;
        --bg-card: #1e1e1e;
        --text-main: #e0e0e0;
        --text-muted: #a0a0a0;
        --border-color: #333;
        --sidebar-width: 260px;
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-dark);
        color: var(--text-main);
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* Sidebar Styles */
      .sidebar {
        width: var(--sidebar-width);
        background-color: var(--bg-card);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 2rem 1.5rem;
        position: fixed;
        height: 100vh;
        z-index: 100;
      }

      .sidebar-header {
        margin-bottom: 3rem;
        text-align: center;
      }

      .sidebar-header h2 {
        color: var(--primary);
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: 0.5px;
      }

      .nav-links {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex: 1;
      }

      .nav-link {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.8rem 1rem;
        color: var(--text-muted);
        text-decoration: none;
        border-radius: 8px;
        transition: var(--transition);
        font-weight: 500;
      }

      .nav-link:hover,
      .nav-link.active {
        background-color: rgba(255, 122, 26, 0.1);
        color: var(--primary);
      }

      .nav-link i {
        width: 20px;
        text-align: center;
      }

      /* User Menu */
      .user-menu {
        margin-top: auto;
        position: relative;
      }

      .user-btn {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 0.8rem 1rem;
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-main);
        cursor: pointer;
        transition: var(--transition);
      }

      .user-btn:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .dropdown-menu {
        position: absolute;
        bottom: 110%;
        left: 0;
        width: 100%;
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.5rem;
        display: none;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .dropdown-menu.show {
        display: block;
        animation: slideUp 0.2s ease;
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.8rem 1rem;
        color: var(--text-muted);
        text-decoration: none;
        border-radius: 6px;
        transition: var(--transition);
      }

      .dropdown-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--text-main);
      }

      .dropdown-item.danger {
        color: #ff4d4d;
      }

      .dropdown-item.danger:hover {
        background-color: rgba(255, 77, 77, 0.1);
      }

      /* Content Area */
      .content {
        margin-left: var(--sidebar-width);
        padding: 2rem;
        flex: 1;
        width: calc(100% - var(--sidebar-width));
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .page-header {
        margin-bottom: 1.5rem;
      }

      .page-header h1 {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 0.25rem;
      }

      .subtitle {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      /* Chat Wrapper */
      .chat-wrapper {
        display: flex;
        gap: 1.5rem;
        flex: 1;
        min-height: 0; /* Important for nested flex scrolling */
      }

      /* Student List */
      .student-list {
        width: 300px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .list-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--text-muted);
        font-size: 0.9rem;
        background: rgba(255, 255, 255, 0.02);
      }

      .list-content {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .student-card {
        padding: 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #333;
      }

      .student-card:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .student-card.selected {
        background: rgba(255, 122, 26, 0.1);
        border-color: var(--primary);
      }

      .student-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        overflow: hidden;
      }

      .student-info strong {
        color: var(--text-main);
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .student-info small {
        color: var(--text-muted);
        font-size: 0.8rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
      }

      .badge {
        background: var(--primary);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
        min-width: 20px;
        text-align: center;
      }

      /* Chat Container */
      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
      }

      .chat-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: rgba(255, 255, 255, 0.02);
        display: flex;
        align-items: center;
        gap: 0.8rem;
      }

      .chat-status-dot {
        width: 8px;
        height: 8px;
        background-color: #4caf50;
        border-radius: 50%;
      }

      .chat-header-text {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      .chat-header-text strong {
        color: var(--primary);
        font-size: 1rem;
        margin-left: 0.3rem;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background-image: radial-gradient(
          rgba(255, 255, 255, 0.03) 1px,
          transparent 1px
        );
        background-size: 20px 20px;
      }

      .message {
        max-width: 70%;
        padding: 1rem 1.2rem;
        border-radius: 12px;
        position: relative;
        line-height: 1.5;
        font-size: 0.95rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .student-msg {
        align-self: flex-start;
        background: #2a2a2a;
        color: var(--text-main);
        border-bottom-left-radius: 2px;
      }

      .admin-msg {
        align-self: flex-end;
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 2px;
      }

      .msg-time {
        font-size: 0.7rem;
        margin-top: 0.4rem;
        display: block;
        opacity: 0.7;
        text-align: right;
      }

      /* Input Area */
      .input-area {
        padding: 1.2rem;
        background: var(--bg-card);
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .input-area input {
        flex: 1;
        padding: 0.9rem 1.2rem;
        border-radius: 25px;
        border: 1px solid var(--border-color);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text-main);
        font-family: inherit;
        transition: var(--transition);
      }

      .input-area input:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(0, 0, 0, 0.3);
      }

      .input-area button {
        padding: 0.9rem 1.5rem;
        border: none;
        border-radius: 25px;
        background: var(--primary);
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .input-area button:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #444;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .content {
          margin-left: 0;
          width: 100%;
          padding: 1rem;
        }
        .chat-wrapper {
          flex-direction: column;
        }
        .student-list {
          width: 100%;
          height: 200px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>ADMIN PANEL</h2>
      </div>
      <div class="nav-links">
        <a href="{{ url_for('admin_dashboard') }}" class="nav-link">
          <i class="fas fa-tachometer-alt"></i>
          <span>Dashboard</span>
        </a>
        <a href="{{ url_for('admin_announcements') }}" class="nav-link">
          <i class="fas fa-bullhorn"></i>
          <span>Announcements</span>
        </a>
        <a
          href="{{ url_for('admin_deans_list_applications') }}"
          class="nav-link"
        >
          <i class="fas fa-award"></i>
          <span>Dean's List</span>
        </a>
        <a href="{{ url_for('admin_chat') }}" class="nav-link active">
          <i class="fas fa-comments"></i>
          <span>Chat Support</span>
        </a>
        <a href="{{ url_for('admin_feedback') }}" class="nav-link">
          <i class="fas fa-comment-dots"></i>
          <span>Feedback</span>
        </a>
        <a href="{{ url_for('admin_ranking') }}" class="nav-link">
          <i class="fas fa-trophy"></i>
          <span>Ranking</span>
        </a>
      </div>
      <div class="user-menu">
        <div class="user-btn" onclick="toggleUserMenu()">
          <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span>Admin</span>
          </div>
          <i class="fas fa-chevron-up"></i>
        </div>
        <div class="dropdown-menu" id="userDropdown">
          <a href="{{ url_for('admin_settings') }}" class="dropdown-item">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
          </a>
          <a href="{{ url_for('admin_logout') }}" class="dropdown-item danger">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </div>
      </div>
    </div>

    <script>
      function toggleUserMenu() {
        const menu = document.getElementById("userDropdown");
        menu.classList.toggle("show");
      }

      // Close dropdown when clicking outside
      window.addEventListener("click", function (e) {
        const userBtn = document.querySelector(".user-btn");
        const menu = document.getElementById("userDropdown");

        if (!userBtn.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.remove("show");
        }
      });
    </script>

    <!-- Content -->
    <div class="content">
      <div class="page-header">
        <h1>Chat Support</h1>
        <p class="subtitle">Real-time communication with students</p>
      </div>

      <div class="chat-wrapper">
        <!-- Left: student list -->
        <div class="student-list">
          <div class="list-header">Recent Chats</div>
          <div class="list-content" id="userList">
            <!-- Populated by JS -->
          </div>
        </div>

        <!-- Right: chat messages -->
        <div class="chat-container">
          <div class="chat-header" id="chatHeader">
            <div class="chat-status-dot"></div>
            <div class="chat-header-text">
              Chatting with: <strong id="chattingWith">None</strong>
            </div>
          </div>

          <div class="messages" id="messages"></div>

          <div class="input-area">
            <input
              type="text"
              id="messageInput"
              placeholder="Type your message..."
            />
            <button onclick="sendMessage()">
              <i class="fas fa-paper-plane"></i> Send
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Add logout confirmation
      const logoutLink = document.querySelector(".dropdown-item.danger");
      if (logoutLink) {
        logoutLink.addEventListener("click", (e) => {
          if (!confirm("Are you sure you want to logout?")) {
            e.preventDefault();
          }
        });
      }

      const userListDiv = document.getElementById("userList");
      const messagesDiv = document.getElementById("messages");
      let currentChatUserId = null;
      let currentStudentName = "";

      function fetchUsers() {
        fetch("/chat/students")
          .then((res) => res.json())
          .then((data) => {
            // ✅ Sort by last_message_time (newest first)
            data.sort(
              (a, b) =>
                new Date(b.last_message_time) - new Date(a.last_message_time)
            );

            userListDiv.innerHTML = "";
            data.forEach((user) => {
              const div = document.createElement("div");
              div.classList.add("student-card");
              div.dataset.userid = user.id;

              const displayName =
                user.name && user.name !== "None" ? user.name : "Unknown";
              div.innerHTML = `
                <div class="student-info">
                    <strong>${displayName}</strong>
                    <small>${user.last_message || ""}</small>
                </div>
                <span class="badge" style="${
                  user.unread_count > 0 ? "" : "display:none;"
                }">
                    ${user.unread_count || 0}
                </span>
            `;

              div.onclick = () => {
                currentChatUserId = user.id;
                currentStudentName = displayName;
                highlightSelectedCard(div);
                fetchMessages(currentChatUserId);
                document.getElementById("chattingWith").innerText = displayName;

                // ✅ Clear unread badge
                const badge = div.querySelector(".badge");
                badge.innerText = "0";
                badge.style.display = "none";
              };

              if (currentChatUserId === user.id) div.classList.add("selected");
              userListDiv.appendChild(div);
            });
          });
      }

      function highlightSelectedCard(selectedDiv) {
        document
          .querySelectorAll(".student-card")
          .forEach((card) => card.classList.remove("selected"));
        selectedDiv.classList.add("selected");
      }

      function fetchMessages(userId) {
        if (!userId) return;
        fetch(`/chat/messages/${userId}`)
          .then((res) => res.json())
          .then((data) => {
            messagesDiv.innerHTML = "";
            data.forEach((m) => {
              const div = document.createElement("div");
              div.classList.add(
                "message",
                m.sender_role === "admin" ? "admin-msg" : "student-msg"
              );
              div.innerHTML = `
                <div>${m.message}</div>
                <span class="msg-time">${new Date(
                  m.timestamp
                ).toLocaleString()}</span>
            `;
              messagesDiv.appendChild(div);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            fetch(`/chat/mark_read/${userId}`, { method: "POST" });
          });
      }

      // --- Socket.IO ---
      let socket;
      function setupSocketIO() {
        socket = io();

        socket.on("connect", () => {
          socket.emit("join", { room: "admin_room" });
        });

        socket.on("receive_message", function (data) {
          // Determine if this message belongs to the currently open chat
          // It belongs if:
          // 1. Sender is the current student (student -> admin)
          // 2. Receiver is the current student (admin -> student)
          const isCurrentChat =
            (data.sender_role === "student" &&
              data.sender_id == currentChatUserId) ||
            (data.sender_role === "admin" &&
              data.receiver_id == currentChatUserId);

          if (isCurrentChat) {
            const div = document.createElement("div");
            // If sender is admin, style as admin-msg (right), else student-msg (left)
            div.classList.add(
              "message",
              data.sender_role === "admin" ? "admin-msg" : "student-msg"
            );

            const dateStr = data.timestamp
              ? new Date(data.timestamp).toLocaleString()
              : new Date().toLocaleString();
            div.innerHTML = `
                <div>${data.message}</div>
                <span class="msg-time">${dateStr}</span>
            `;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Mark as read immediately if we are looking at it
            if (data.sender_role === "student") {
              fetch(`/chat/mark_read/${data.sender_id}`, { method: "POST" });
            }
          }

          // Update the sidebar list
          // If it's a student message, the ID is sender_id
          // If it's an admin message, the ID is receiver_id (the student we are talking to)
          const relevantStudentId =
            data.sender_role === "student" ? data.sender_id : data.receiver_id;
          const currentCard = document.querySelector(
            `.student-card[data-userid="${relevantStudentId}"]`
          );

          if (currentCard) {
            // Update preview text
            currentCard.querySelector("small").innerText = data.message;

            // Update badge only if it's an incoming message from a student AND we are NOT looking at it
            if (
              data.sender_role === "student" &&
              relevantStudentId != currentChatUserId
            ) {
              const badge = currentCard.querySelector(".badge");
              let count = parseInt(badge.innerText) || 0;
              badge.innerText = count + 1;
              badge.style.display = "inline-block";
            }

            // Move to top
            userListDiv.prepend(currentCard);
          } else {
            // If the student isn't in the list (new chat), refresh the list
            fetchUsers();
          }
        });
      }
      setupSocketIO();

      function sendMessage() {
        if (!currentChatUserId) return alert("Select a student first!");

        const msgInput = document.getElementById("messageInput");
        const msg = msgInput.value.trim();
        if (!msg) return;

        socket.emit("send_message", {
          sender_role: "admin",
          sender_name: "Admin", // Or use template variable if available
          sender_id: "admin",
          receiver_id: currentChatUserId,
          message: msg,
        });

        msgInput.value = "";
        // Note: We don't manually append the message here anymore because
        // the server will echo it back to 'admin_room', which triggers 'receive_message'
      }

      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
          }
        });

      fetchUsers();
    </script>
  </body>
</html>
